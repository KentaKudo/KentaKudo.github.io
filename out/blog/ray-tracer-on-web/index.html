<!DOCTYPE html><html lang="en" class="__variable_03f989"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/09f7b6b7f4b56175-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/2adcbd32d109d254.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/59ab89f451b37a95.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-5a42b64609345d7d.js"/><script src="/_next/static/chunks/9145d1e3-43e3205d69e381df.js" async=""></script><script src="/_next/static/chunks/516-a52a4b024057d16f.js" async=""></script><script src="/_next/static/chunks/main-app-0eaf5281b3c47258.js" async=""></script><script src="/_next/static/chunks/518-6a3bc66be2ae21f8.js" async=""></script><script src="/_next/static/chunks/421-396596b9663107c1.js" async=""></script><script src="/_next/static/chunks/app/blog/%5Bslug%5D/page-2f95eb661e1f5aa0.js" async=""></script><script src="/_next/static/chunks/210-656918ce86738ee9.js" async=""></script><script src="/_next/static/chunks/100-d4a80b02d8331266.js" async=""></script><script src="/_next/static/chunks/app/layout-b8043213ae1c3ba0.js" async=""></script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-FC2KF4RL0P"></script><title>Ray Tracer on Web | Kenta Kudo</title><meta name="description" content="I have been working on writing a ray tracer in Rust in the last few weeks. This post is to show off what I could achieve:)"/><meta property="og:title" content="Kenta Kudo"/><meta property="og:description" content="Welcome to my page!"/><meta property="og:image" content="https://kentakudo.com/images/river-themes.jpg"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:creator" content="@___________k_k_"/><meta name="twitter:title" content="Kenta Kudo"/><meta name="twitter:description" content="Welcome to my page!"/><meta name="twitter:image" content="https://kentakudo.com/images/river-themes.jpg"/><link rel="icon" href="/favicon.ico" type="image/x-icon" sizes="72x72"/><meta name="next-size-adjust"/><script async="">
                window.dataLayer = window.dataLayer || [];
                function gtag(){dataLayer.push(arguments);}
                gtag('js', new Date());
                gtag('config', 'G-FC2KF4RL0P');
              </script><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body><header class="sticky top-0 px-4 backdrop-blur-sm"><div class="h-20 mx-auto w-full max-w-screen-lg flex items-center justify-between"><a class="font-bold font-permanent-marker text-2xl" href="/">K</a><nav class="font-bold text-slate-500"><ul class="flex gap-4"><li class="hover:text-foreground"><a href="/">Home</a></li><li class="hover:text-foreground"><a href="/about/">About</a></li><li class="hover:text-foreground"><a href="/blog/">Blog</a></li></ul></nav></div></header><main class="w-full max-w-screen-md mx-auto py-4 px-4"><figure class="flex flex-col gap-1 items-center"><img alt="Laser beams in darkness" loading="lazy" width="736" height="490" decoding="async" data-nimg="1" class="rounded-lg overflow-hidden shadow-md" style="color:transparent" src="/images/laser.jpg"/><figcaption class="text-slate-400 text-sm [&amp;&gt;a]:italic [&amp;&gt;a]:underline">Photo by <a href="https://unsplash.com/@clyde_he?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Clyde He</a> on <a href="https://unsplash.com/s/photos/light?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a></figcaption></figure><div class="flex items-center justify-between mt-8"><h1 class="font-bold text-4xl">Ray Tracer on Web</h1><button class="flex items-center gap-2 px-3 py-1 text-sm bg-blue-500 text-white rounded hover:bg-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-share2 "><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" x2="15.42" y1="13.51" y2="17.49"></line><line x1="15.41" x2="8.59" y1="6.51" y2="10.49"></line></svg>Share</button></div><time class="italic text-slate-400 block mt-2 mb-8">March 3, 2022</time><main class="flex flex-col gap-4 pt-20 pb-24 [&amp;_h2]:text-2xl [&amp;_h3]:text-xl [&amp;_h4]:text-lg [&amp;_:is(h2,h3,h4,h5,h6)]:font-bold [&amp;_:is(h2,h3,h4,h5,h6)]:leading-relaxed [&amp;_:is(h2,h3,h4,h5,h6)]:mt-8 [&amp;_a]:underline [&amp;_a]:underline-offset-2 [&amp;_a]:decoration-slate-300 [&amp;_aside]:text-accent-foreground [&amp;_aside]:bg-accent [&amp;_aside]:rounded-md [&amp;_aside]:p-5 [&amp;_ul]:pl-4 [&amp;_ul]:list-disc [&amp;_ul]:list-outside [&amp;_ul_ul]:pl-8"><p>First things first: demonstration. Try clicking the Run button below. It&#x27;s going to take a bit while until the result pops up, so please be patient:)</p>
<p>(NOTE: Web Worker must be <a href="https://caniuse.com/webworkers">supported</a> on your browser.)</p>
<!-- -->
<div class="relative flex flex-col items-center"><div class="absolute top-1/2 left-1/2 translate-x-[-50%] translate-y-[-50%] flex flex-col items-center justify-items-center gap-2"><p>⚠️ This operation blocks the main thread.</p><button class="bg-slate-500 hover:bg-slate-700 text-white font-bold py-2 px-4 rounded">Run</button></div><canvas class="w-full max-w-screen-sm aspect-video"></canvas></div>
<p>It didn&#x27;t load the image but <strong>generated it on your device</strong> using the power of Web Assembly. Because it has some random factor, it produces slightly different images every time you run it.</p>
<p>It&#x27;s cool, isn&#x27;t it?</p>
<p>I&#x27;m first going to touch on what ray tracer / ray tracing is for those who are not familiar with it. Then look at details of how I ran it in the browser.</p>
<!-- -->
<aside><p>Many thanks to <a href="https://twitter.com/Peter_shirley">@Peter_shirley</a> who wrote a phenomenal tutorial <a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html">Ray Tracing In One Weekend</a>. I just followed his tutorial using Rust instead of C++.</p></aside>
<p>The source code is available on <a href="https://github.com/KentaKudo/wasm-raytracer">GitHub</a>, and also published as a <a href="https://www.npmjs.com/package/wasm-raytracer">NPM package</a>.</p>
<h2 id="contents"><a aria-hidden="true" tabindex="-1" href="#contents"><span class="icon icon-link"></span></a>Contents</h2>
<ul>
<li><a href="#whats-ray-tracing">What&#x27;s ray tracing?</a>
<ul>
<li><a href="#scene">Scene</a></li>
<li><a href="#camera">Camera</a></li>
<li><a href="#ray">Ray</a></li>
</ul>
</li>
<li><a href="#ray-tracer--web-assembly">Ray tracer + Web Assembly</a>
<ul>
<li><a href="#canvas-api">Canvas API</a></li>
<li><a href="#wasm-bindgen">wasm-bindgen</a></li>
<li><a href="#web-worker">Web Worker</a></li>
<li><a href="#multi-threading">Multi-threading</a></li>
</ul>
</li>
<li><a href="#why-ray-tracer">Why ray tracer?</a></li>
<li><a href="#references">References</a></li>
</ul>
<h2 id="whats-ray-tracing"><a aria-hidden="true" tabindex="-1" href="#whats-ray-tracing"><span class="icon icon-link"></span></a>What&#x27;s ray tracing?</h2>
<p>Ray tracing is a technique used to render a scene. Pay close attention to the shadows and the reflection on water, walls, floors, and glasses in this video.</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/Xf2QCdScU6o" title="YouTube video player" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowFullScreen="" class="mx-auto"></iframe>
<p>You may find the scene rendered by ray tracing more natural.</p>
<p>While ray tracing is computationaly more expensive than the widely used method <em>rasterisation</em>, it&#x27;s been increasing its presence in movie and game rendering with the help of the latest advance in GPU technology.</p>
<p>Programatically, it calculates the colour of each pixel in the image from top left to right bottom tracing &quot;rays&quot; from a &quot;camera&quot; to the &quot;scene&quot;.</p>
<h3 id="scene"><a aria-hidden="true" tabindex="-1" href="#scene"><span class="icon icon-link"></span></a>Scene</h3>
<p>A scene is the world where all the objects, for example cars, lights, buildings, and so on, are placed. My ray tracer only has simple spheres as they&#x27;re easy to model, but you can put literally any objects in any positions if you manage to model it.</p>
<p>You can add other factors to objects to make it look more real. One such factor is a <strong>material</strong> the object is made of. Depending on the material, the object behaves differently when a ray hits. Materials supported by my version of ray tracer are:</p>
<ul>
<li>Lambertian — a material that reflects the ray to a random direction,</li>
<li>Metal — a material that reflects the ray to the direction calculated from the incoming ray&#x27;s angle, and</li>
<li>Dielectric (glasses) — a material that refracts the ray to the inside of the object.</li>
</ul>
<!-- -->
<figure><img src="[object Object]" alt="Lambertian casts a ray to a random direction, Metal reflects, Dielectric refracts"/><figcaption>Each material baheves differently when a ray hits it</figcaption></figure>
<p>Once you define a scene, the next thing you need to do is to specify where you look at the scene from.</p>
<h3 id="camera"><a aria-hidden="true" tabindex="-1" href="#camera"><span class="icon icon-link"></span></a>Camera</h3>
<p>A camera is your eyes. All the rays start their journey from the camera. It&#x27;s defined with two main parameters:</p>
<ul>
<li>position — the place where you look at the scene from, and</li>
<li>atitude — the direction of its gaze</li>
</ul>
<p>In addition to them, you also need to configure
(1) a viewport which has the same aspect ratio as the final image, think it as a window which you look at the scene through, and
(2) the distance between the camera and the viewport, which is called &quot;focal length&quot;.</p>
<p>Once the camera is positioned, it&#x27;s ready to start casting rays.</p>
<h3 id="ray"><a aria-hidden="true" tabindex="-1" href="#ray"><span class="icon icon-link"></span></a>Ray</h3>
<p>A ray is casted from the camera to the direction of the pixel it&#x27;s interested in at the time. The casted ray may or may not hit objects placed in the scene. If it hits something, it first records the color of the object surface. Then, it produces another ray, the direction of which depends on the material of the object as explained in the scene section, from the hit point.</p>
<p>The tracing of the ray stops either
(1) when the ray goes deep into the shadow or
(2) when it doesn&#x27;t hit anything anymore, which means it reaches the ambient light (or sky so to speak).
The final colour of the pixel is calculated at that point.</p>
<!-- -->
<figure><img src="[object Object]" alt="A ray is cast from a camera to the scene through a frame in between them calculating the final colour of the pixel"/><figcaption>Tracing the journey of the ray</figcaption></figure>
<p>This is a quick explanation of what the ray tracer is. See the <a href="#references"><em>References</em></a> section to continue reading more about ray tracing if you&#x27;re interested.</p>
<p>Now, let&#x27;s talk about what I did to run it on web browser.</p>
<h2 id="ray-tracer--web-assembly"><a aria-hidden="true" tabindex="-1" href="#ray-tracer--web-assembly"><span class="icon icon-link"></span></a>Ray tracer + Web Assembly</h2>
<p>The first thing I had to do was make a decision on how JavaScript and Rust should communicate each other; more precisely, how to pass images from Rust to JavaScript.</p>
<h3 id="canvas-api"><a aria-hidden="true" tabindex="-1" href="#canvas-api"><span class="icon icon-link"></span></a>Canvas API</h3>
<p>To draw an image on the screen, I used the &lt;canvas&gt; HTML element. Its <code>putImageData()</code> API receives input image as an <code>ImageData</code> object, and the image data is given as <code>Uint8ClampedArray</code>, which is expected to be an array containing the pixel data in the RGBA order.</p>
<!-- -->
<figure><img src="[object Object]" alt="Uint8ClampedArray is used for ImageData then passed to canvas HTML element."/></figure>
<p>Long story short, the goal is to return a properly serialised <code>Uint8ClampedArray</code> from the Rust programme.</p>
<h3 id="wasm-bindgen"><a aria-hidden="true" tabindex="-1" href="#wasm-bindgen"><span class="icon icon-link"></span></a>wasm-bindgen</h3>
<p><a href="https://github.com/rustwasm/wasm-bindgen">wasm-bindgen</a> is a library that bridges the gap between JavaScript and the Web Assembly module written in Rust.</p>
<p>What I needed to do so the <code>render</code> function can be called from JavaScript and return <code>Uint8ClampedArray</code> was to add a <code>#[wasm_bindgen]</code> annotation and modify the return type:</p>
<pre><code class="hljs language-rust"><span class="hljs-keyword">use</span> wasm_bindgen::prelude::*;

<span class="hljs-meta">#[wasm_bindgen]</span>
<span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">render</span>(width: <span class="hljs-type">u16</span>, height: <span class="hljs-type">u16</span>) <span class="hljs-punctuation">-&gt;</span> Uint8ClampedArray {

  <span class="hljs-comment">// ...setup a scene and a camera</span>

  <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">img</span> = <span class="hljs-built_in">vec!</span>[];

  <span class="hljs-comment">// ...build image</span>

  <span class="hljs-comment">// convert from [u8] to Uint8ClampedArray using Into trait.</span>
  img[..].<span class="hljs-title function_ invoke__">into</span>()
}
</code></pre>
<p>This is basically everything I needed to run the ray tracer in web browser, but there was one issue when I tried it: the browser got stuck while running the ray tracer. What I was missing was to follow this advice:</p>
<blockquote>
<p>The main thread in a browser cannot block. This means that if you run WebAssembly code on the main thread you can never block, meaning you can&#x27;t do so much as acquire a mutex. This is an extremely difficult limitation to work with on the web, although one workaround is to run wasm exclusively in web workers and run JS on the main thread. It is possible to run the same wasm across all threads, but you need to be extremely vigilant about synchronization with the main thread. —— <a href="https://rustwasm.github.io/wasm-bindgen/examples/raytrace.html#caveats">Parallel Raytracing#caveats</a></p>
</blockquote>
<p>Because ray tracing takes some time and blocks the thread where it runs, running it on the main thread is a no-no; I made a first encounter to Web Worker...!</p>
<h3 id="web-worker"><a aria-hidden="true" tabindex="-1" href="#web-worker"><span class="icon icon-link"></span></a>Web Worker</h3>
<p>Regardless of its unfriendly interface (<a href="https://github.com/GoogleChromeLabs/comlink">Comlink</a> can be a help for it), using Web Worker is not super complicated.</p>
<p>The main thread needs to (1) instantiate a worker specifying the path to the worker file, (2) invoke it passing arguments via <code>postMessage</code> API, and (3) listen to the result by registering an <code>onmessage</code> callback:</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">const</span> w = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">&quot;../path/to/the/worker/file&quot;</span>);
w.<span class="hljs-title function_">postMessage</span>([<span class="hljs-variable constant_">WIDTH</span>, <span class="hljs-variable constant_">HEIGHT</span>]);
w.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">{ data: rendered }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> imageData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageData</span>(rendered, <span class="hljs-variable constant_">WIDTH</span>);
  canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">&quot;2d&quot;</span>).<span class="hljs-title function_">putImageData</span>(imageData, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
};
</code></pre>
<p>The worker in return defines an <code>onmessage</code> method, calls the wasm function, and pass back the result using <code>postMessage</code> API:</p>
<pre><code class="hljs language-js">onmessage = <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">e</span>) {
  <span class="hljs-keyword">const</span> { render } = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;wasm-raytracer&quot;</span>);
  <span class="hljs-keyword">const</span> rendered = <span class="hljs-title function_">render</span>(e.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>], e.<span class="hljs-property">data</span>[<span class="hljs-number">1</span>]);
  <span class="hljs-title function_">postMessage</span>(rendered);
};
</code></pre>
<p>This was all I needed to run ray tracer on a dedicated thread.</p>
<p>Before closing the section, I address the performance issue I tried to solve.</p>
<h3 id="multi-threading"><a aria-hidden="true" tabindex="-1" href="#multi-threading"><span class="icon icon-link"></span></a>Multi-threading</h3>
<p>Even though now it&#x27;s separated from the main thread, running it on a single thread takes a bit of time. To improve performance, I looked at options to run it on multiple threads.</p>
<p>The calculation of each pixel can be done in isolatation from each other, and <em>fork-join parallelism</em>, which is to <em>fork</em> to start a new thread and to join to <em>wait</em> for it to finish, can be applied using libraries such as <a href="https://github.com/rayon-rs/rayon">Rayon</a>.</p>
<p>Even though it wasn&#x27;t difficult to turn the programme into the multi-thread version, there were a couple of challenges to run it in the browser environment:</p>
<ul>
<li>WebAssembly threads are not supported by <a href="https://webassembly.org/roadmap/">some browsers</a> yet.</li>
<li>To enable it, <a href="https://web.dev/coop-coep/">COOP and COEP headers</a> need to be configured properly, which is not possble for GitHub pages where this blog is hosted as of today.</li>
<li>Because Rust&#x27;s wasm build target doesn&#x27;t assume it&#x27;s going to be run in browsers, the standard library <code>std::thread</code> is not aware of Web Workers that enable WebAssembly threads on browser environments.</li>
<li>The <a href="https://github.com/GoogleChromeLabs/wasm-bindgen-rayon"><code>wasm-bindgen-rayon</code> library</a> enables compiling multi-thread code written with the Rayon library into threads aware wasm, but only with the nightly version of Rust.</li>
</ul>
<p>For those reasons, I gave up multi-threading for now hoping I can introduce it in the near future.</p>
<h2 id="why-ray-tracer"><a aria-hidden="true" tabindex="-1" href="#why-ray-tracer"><span class="icon icon-link"></span></a>Why ray tracer?</h2>
<p>This is kind of a detour from my journey of the <a href="/blog/cpu-experiment">CPU experiment</a> aimed at understanding what ray tracer is and how to implement it (+ not to mention learning Rust). Next challenge is to migrate the ray tracer programme to the Hack/Jack system I built while I was reading the book I introduced in the last section of the <a href="/blog/the-power-of-nand">The Power of NAND</a> post. Bye for now:)</p>
<h2 id="references"><a aria-hidden="true" tabindex="-1" href="#references"><span class="icon icon-link"></span></a>References</h2>
<ul>
<li><a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html">Ray Tracing In One Weekend</a></li>
<li><a href="https://blog.singleton.io/posts/2022-01-02-raytracing-with-rust/">The joy of building a ray tracer, for fun, in Rust.</a></li>
<li><a href="https://bheisler.github.io/post/writing-raytracer-in-rust-part-1/">Writing a Raytracer in Rust</a></li>
<li><a href="https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/">Shaking Off the Rust 2: Ray Tracing in WebAssembly</a></li>
<li><a href="https://rustwasm.github.io/wasm-bindgen/examples/raytrace.html">Parallel Raytracing</a></li>
<li><a href="https://web.dev/webassembly-threads/">Using WebAssembly threads from C, C++ and Rust</a></li>
</ul></main></main><script src="/_next/static/chunks/webpack-5a42b64609345d7d.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/09f7b6b7f4b56175-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/2adcbd32d109d254.css\",\"style\"]\n3:HL[\"/_next/static/css/59ab89f451b37a95.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"4:I[8418,[],\"\"]\n6:I[9518,[\"518\",\"static/chunks/518-6a3bc66be2ae21f8.js\",\"421\",\"static/chunks/421-396596b9663107c1.js\",\"308\",\"static/chunks/app/blog/%5Bslug%5D/page-2f95eb661e1f5aa0.js\"],\"Image\"]\n7:I[6035,[\"518\",\"static/chunks/518-6a3bc66be2ae21f8.js\",\"421\",\"static/chunks/421-396596b9663107c1.js\",\"308\",\"static/chunks/app/blog/%5Bslug%5D/page-2f95eb661e1f5aa0.js\"],\"ShareButton\"]\n8:I[8945,[\"518\",\"static/chunks/518-6a3bc66be2ae21f8.js\",\"421\",\"static/chunks/421-396596b9663107c1.js\",\"308\",\"static/chunks/app/blog/%5Bslug%5D/page-2f95eb661e1f5aa0.js\"],\"RayTracerCanvas\"]\n9:I[2807,[],\"\"]\nb:I[9965,[],\"\"]\nc:I[2032,[\"210\",\"static/chunks/210-656918ce86738ee9.js\",\"100\",\"static/chunks/100-d4a80b02d8331266.js\",\"185\",\"static/chunks/app/layout-b8043213ae1c3ba0.js\"],\"Header\"]\ne:I[5128,[],\"\"]\na:[\"slug\",\"ray-tracer-on-web\",\"d\"]\nf:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/2adcbd32d109d254.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L4\",null,{\"buildId\":\"_0OL2R4APCchkkBg7dSD7\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/ray-tracer-on-web/\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"ray-tracer-on-web\",\"d\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":\\\"ray-tracer-on-web\\\"}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"ray-tracer-on-web\",\"d\"],{\"children\":[\"__PAGE__\",{},[[\"$L5\",[[\"$\",\"figure\",null,{\"className\":\"flex flex-col gap-1 items-center\",\"children\":[[\"$\",\"$L6\",null,{\"src\":\"/images/laser.jpg\",\"alt\":\"Laser beams in darkness\",\"className\":\"rounded-lg overflow-hidden shadow-md\",\"width\":736,\"height\":490}],[\"$\",\"figcaption\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"Photo by \u003ca href=\\\"https://unsplash.com/@clyde_he?utm_source=unsplash\u0026utm_medium=referral\u0026utm_content=creditCopyText\\\"\u003eClyde He\u003c/a\u003e on \u003ca href=\\\"https://unsplash.com/s/photos/light?utm_source=unsplash\u0026utm_medium=referral\u0026utm_content=creditCopyText\\\"\u003eUnsplash\u003c/a\u003e\"},\"className\":\"text-slate-400 text-sm [\u0026\u003ea]:italic [\u0026\u003ea]:underline\"}]]}],[\"$\",\"div\",null,{\"className\":\"flex items-center justify-between mt-8\",\"children\":[[\"$\",\"h1\",null,{\"className\":\"font-bold text-4xl\",\"children\":\"Ray Tracer on Web\"}],[\"$\",\"$L7\",null,{\"url\":\"/blog/ray-tracer-on-web\",\"title\":\"Ray Tracer on Web\"}]]}],[\"$\",\"time\",null,{\"className\":\"italic text-slate-400 block mt-2 mb-8\",\"children\":\"March 3, 2022\"}],[\"$\",\"main\",null,{\"className\":\"flex flex-col gap-4 pt-20 pb-24 [\u0026_h2]:text-2xl [\u0026_h3]:text-xl [\u0026_h4]:text-lg [\u0026_:is(h2,h3,h4,h5,h6)]:font-bold [\u0026_:is(h2,h3,h4,h5,h6)]:leading-relaxed [\u0026_:is(h2,h3,h4,h5,h6)]:mt-8 [\u0026_a]:underline [\u0026_a]:underline-offset-2 [\u0026_a]:decoration-slate-300 [\u0026_aside]:text-accent-foreground [\u0026_aside]:bg-accent [\u0026_aside]:rounded-md [\u0026_aside]:p-5 [\u0026_ul]:pl-4 [\u0026_ul]:list-disc [\u0026_ul]:list-outside [\u0026_ul_ul]:pl-8\",\"children\":[[\"$\",\"p\",null,{\"children\":\"First things first: demonstration. Try clicking the Run button below. It's going to take a bit while until the result pops up, so please be patient:)\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"(NOTE: Web Worker must be \",[\"$\",\"a\",null,{\"href\":\"https://caniuse.com/webworkers\",\"children\":\"supported\"}],\" on your browser.)\"]}],\"\\n\",\"\\n\",[\"$\",\"$L8\",null,{}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"It didn't load the image but \",[\"$\",\"strong\",null,{\"children\":\"generated it on your device\"}],\" using the power of Web Assembly. Because it has some random factor, it produces slightly different images every time you run it.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"It's cool, isn't it?\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"I'm first going to touch on what ray tracer / ray tracing is for those who are not familiar with it. Then look at details of how I ran it in the browser.\"}],\"\\n\",\"\\n\",[\"$\",\"aside\",null,{\"children\":[\"$\",\"p\",null,{\"children\":[\"Many thanks to \",[\"$\",\"a\",null,{\"href\":\"https://twitter.com/Peter_shirley\",\"children\":\"@Peter_shirley\"}],\" who wrote a phenomenal tutorial \",[\"$\",\"a\",null,{\"href\":\"https://raytracing.github.io/books/RayTracingInOneWeekend.html\",\"children\":\"Ray Tracing In One Weekend\"}],\". I just followed his tutorial using Rust instead of C++.\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The source code is available on \",[\"$\",\"a\",null,{\"href\":\"https://github.com/KentaKudo/wasm-raytracer\",\"children\":\"GitHub\"}],\", and also published as a \",[\"$\",\"a\",null,{\"href\":\"https://www.npmjs.com/package/wasm-raytracer\",\"children\":\"NPM package\"}],\".\"]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"contents\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#contents\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Contents\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"#whats-ray-tracing\",\"children\":\"What's ray tracing?\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#scene\",\"children\":\"Scene\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#camera\",\"children\":\"Camera\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#ray\",\"children\":\"Ray\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"#ray-tracer--web-assembly\",\"children\":\"Ray tracer + Web Assembly\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#canvas-api\",\"children\":\"Canvas API\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#wasm-bindgen\",\"children\":\"wasm-bindgen\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#web-worker\",\"children\":\"Web Worker\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#multi-threading\",\"children\":\"Multi-threading\"}]}],\"\\n\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#why-ray-tracer\",\"children\":\"Why ray tracer?\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"#references\",\"children\":\"References\"}]}],\"\\n\"]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"whats-ray-tracing\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#whats-ray-tracing\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"What's ray tracing?\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Ray tracing is a technique used to render a scene. Pay close attention to the shadows and the reflection on water, walls, floors, and glasses in this video.\"}],\"\\n\",[\"$\",\"iframe\",null,{\"width\":\"560\",\"height\":\"315\",\"src\":\"https://www.youtube.com/embed/Xf2QCdScU6o\",\"title\":\"YouTube video player\",\"allow\":\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\",\"allowFullScreen\":true,\"className\":\"mx-auto\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"You may find the scene rendered by ray tracing more natural.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"While ray tracing is computationaly more expensive than the widely used method \",[\"$\",\"em\",null,{\"children\":\"rasterisation\"}],\", it's been increasing its presence in movie and game rendering with the help of the latest advance in GPU technology.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Programatically, it calculates the colour of each pixel in the image from top left to right bottom tracing \\\"rays\\\" from a \\\"camera\\\" to the \\\"scene\\\".\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"scene\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#scene\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Scene\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"A scene is the world where all the objects, for example cars, lights, buildings, and so on, are placed. My ray tracer only has simple spheres as they're easy to model, but you can put literally any objects in any positions if you manage to model it.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"You can add other factors to objects to make it look more real. One such factor is a \",[\"$\",\"strong\",null,{\"children\":\"material\"}],\" the object is made of. Depending on the material, the object behaves differently when a ray hits. Materials supported by my version of ray tracer are:\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"Lambertian — a material that reflects the ray to a random direction,\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Metal — a material that reflects the ray to the direction calculated from the incoming ray's angle, and\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"Dielectric (glasses) — a material that refracts the ray to the inside of the object.\"}],\"\\n\"]}],\"\\n\",\"\\n\",[\"$\",\"figure\",null,{\"children\":[[\"$\",\"img\",null,{\"src\":{\"src\":\"/_next/static/media/materials.5aa8afc9.png\",\"height\":638,\"width\":2694,\"blurDataURL\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAACCAIAAADq9gq6AAAAJ0lEQVR42hXIsREAAAjCQPcfGQindvlMwRLwYbeFP5PkTHv4AEmxF56BLz1TSs8QAAAAAElFTkSuQmCC\",\"blurWidth\":8,\"blurHeight\":2},\"alt\":\"Lambertian casts a ray to a random direction, Metal reflects, Dielectric refracts\"}],[\"$\",\"figcaption\",null,{\"children\":\"Each material baheves differently when a ray hits it\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Once you define a scene, the next thing you need to do is to specify where you look at the scene from.\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"camera\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#camera\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Camera\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"A camera is your eyes. All the rays start their journey from the camera. It's defined with two main parameters:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":\"position — the place where you look at the scene from, and\"}],\"\\n\",[\"$\",\"li\",null,{\"children\":\"atitude — the direction of its gaze\"}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"In addition to them, you also need to configure\\n(1) a viewport which has the same aspect ratio as the final image, think it as a window which you look at the scene through, and\\n(2) the distance between the camera and the viewport, which is called \\\"focal length\\\".\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Once the camera is positioned, it's ready to start casting rays.\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"ray\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#ray\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Ray\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"A ray is casted from the camera to the direction of the pixel it's interested in at the time. The casted ray may or may not hit objects placed in the scene. If it hits something, it first records the color of the object surface. Then, it produces another ray, the direction of which depends on the material of the object as explained in the scene section, from the hit point.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The tracing of the ray stops either\\n(1) when the ray goes deep into the shadow or\\n(2) when it doesn't hit anything anymore, which means it reaches the ambient light (or sky so to speak).\\nThe final colour of the pixel is calculated at that point.\"}],\"\\n\",\"\\n\",[\"$\",\"figure\",null,{\"children\":[[\"$\",\"img\",null,{\"src\":{\"src\":\"/_next/static/media/ray.ab22f79e.png\",\"height\":1101,\"width\":2274,\"blurDataURL\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAECAIAAAA8r+mnAAAAT0lEQVR42h2KQQqAMAwE+/8vevAoiuil1aZJJqYuLCw7UwBVdfDekfFqP58rIkq+IjKZWbi30fZ6TJAFzDzH3XTdJQXwAvwsMlfVZetqBHxW3l3MWb2UpQAAAABJRU5ErkJggg==\",\"blurWidth\":8,\"blurHeight\":4},\"alt\":\"A ray is cast from a camera to the scene through a frame in between them calculating the final colour of the pixel\"}],[\"$\",\"figcaption\",null,{\"children\":\"Tracing the journey of the ray\"}]]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"This is a quick explanation of what the ray tracer is. See the \",[\"$\",\"a\",null,{\"href\":\"#references\",\"children\":[\"$\",\"em\",null,{\"children\":\"References\"}]}],\" section to continue reading more about ray tracing if you're interested.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Now, let's talk about what I did to run it on web browser.\"}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"ray-tracer--web-assembly\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#ray-tracer--web-assembly\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Ray tracer + Web Assembly\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"The first thing I had to do was make a decision on how JavaScript and Rust should communicate each other; more precisely, how to pass images from Rust to JavaScript.\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"canvas-api\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#canvas-api\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Canvas API\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"To draw an image on the screen, I used the \u003ccanvas\u003e HTML element. Its \",[\"$\",\"code\",null,{\"children\":\"putImageData()\"}],\" API receives input image as an \",[\"$\",\"code\",null,{\"children\":\"ImageData\"}],\" object, and the image data is given as \",[\"$\",\"code\",null,{\"children\":\"Uint8ClampedArray\"}],\", which is expected to be an array containing the pixel data in the RGBA order.\"]}],\"\\n\",\"\\n\",[\"$\",\"figure\",null,{\"children\":[\"$\",\"img\",null,{\"src\":{\"src\":\"/_next/static/media/canvas-api.0d42b62c.png\",\"height\":314,\"width\":1708,\"blurDataURL\":\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAABCAIAAABsYngUAAAAGElEQVR42mP4CQZ/YOD///+fP39+/eYNACVTF0w5Y5WdAAAAAElFTkSuQmCC\",\"blurWidth\":8,\"blurHeight\":1},\"alt\":\"Uint8ClampedArray is used for ImageData then passed to canvas HTML element.\"}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Long story short, the goal is to return a properly serialised \",[\"$\",\"code\",null,{\"children\":\"Uint8ClampedArray\"}],\" from the Rust programme.\"]}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"wasm-bindgen\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#wasm-bindgen\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"wasm-bindgen\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[[\"$\",\"a\",null,{\"href\":\"https://github.com/rustwasm/wasm-bindgen\",\"children\":\"wasm-bindgen\"}],\" is a library that bridges the gap between JavaScript and the Web Assembly module written in Rust.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"What I needed to do so the \",[\"$\",\"code\",null,{\"children\":\"render\"}],\" function can be called from JavaScript and return \",[\"$\",\"code\",null,{\"children\":\"Uint8ClampedArray\"}],\" was to add a \",[\"$\",\"code\",null,{\"children\":\"#[wasm_bindgen]\"}],\" annotation and modify the return type:\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-rust\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"use\"}],\" wasm_bindgen::prelude::*;\\n\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-meta\",\"children\":\"#[wasm_bindgen]\"}],\"\\n\",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"pub\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"fn\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"render\"}],\"(width: \",[\"$\",\"span\",null,{\"className\":\"hljs-type\",\"children\":\"u16\"}],\", height: \",[\"$\",\"span\",null,{\"className\":\"hljs-type\",\"children\":\"u16\"}],\") \",[\"$\",\"span\",null,{\"className\":\"hljs-punctuation\",\"children\":\"-\u003e\"}],\" Uint8ClampedArray {\\n\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"// ...setup a scene and a camera\"}],\"\\n\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"let\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"mut \"}],[\"$\",\"span\",null,{\"className\":\"hljs-variable\",\"children\":\"img\"}],\" = \",[\"$\",\"span\",null,{\"className\":\"hljs-built_in\",\"children\":\"vec!\"}],\"[];\\n\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"// ...build image\"}],\"\\n\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-comment\",\"children\":\"// convert from [u8] to Uint8ClampedArray using Into trait.\"}],\"\\n  img[..].\",[\"$\",\"span\",null,{\"className\":\"hljs-title function_ invoke__\",\"children\":\"into\"}],\"()\\n}\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"This is basically everything I needed to run the ray tracer in web browser, but there was one issue when I tried it: the browser got stuck while running the ray tracer. What I was missing was to follow this advice:\"}],\"\\n\",[\"$\",\"blockquote\",null,{\"children\":[\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The main thread in a browser cannot block. This means that if you run WebAssembly code on the main thread you can never block, meaning you can't do so much as acquire a mutex. This is an extremely difficult limitation to work with on the web, although one workaround is to run wasm exclusively in web workers and run JS on the main thread. It is possible to run the same wasm across all threads, but you need to be extremely vigilant about synchronization with the main thread. —— \",[\"$\",\"a\",null,{\"href\":\"https://rustwasm.github.io/wasm-bindgen/examples/raytrace.html#caveats\",\"children\":\"Parallel Raytracing#caveats\"}]]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Because ray tracing takes some time and blocks the thread where it runs, running it on the main thread is a no-no; I made a first encounter to Web Worker...!\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"web-worker\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#web-worker\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Web Worker\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"Regardless of its unfriendly interface (\",[\"$\",\"a\",null,{\"href\":\"https://github.com/GoogleChromeLabs/comlink\",\"children\":\"Comlink\"}],\" can be a help for it), using Web Worker is not super complicated.\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The main thread needs to (1) instantiate a worker specifying the path to the worker file, (2) invoke it passing arguments via \",[\"$\",\"code\",null,{\"children\":\"postMessage\"}],\" API, and (3) listen to the result by registering an \",[\"$\",\"code\",null,{\"children\":\"onmessage\"}],\" callback:\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-js\",\"children\":[[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" w = \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-title class_\",\"children\":\"Worker\"}],\"(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"../path/to/the/worker/file\\\"\"}],\");\\nw.\",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"postMessage\"}],\"([\",[\"$\",\"span\",null,{\"className\":\"hljs-variable constant_\",\"children\":\"WIDTH\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-variable constant_\",\"children\":\"HEIGHT\"}],\"]);\\nw.\",[\"$\",\"span\",null,{\"className\":\"hljs-property\",\"children\":\"onmessage\"}],\" = \",[\"$\",\"span\",null,{\"className\":\"hljs-function\",\"children\":[\"(\",[\"$\",\"span\",null,{\"className\":\"hljs-params\",\"children\":\"{ data: rendered }\"}],\") =\u003e\"]}],\" {\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" imageData = \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-title class_\",\"children\":\"ImageData\"}],\"(rendered, \",[\"$\",\"span\",null,{\"className\":\"hljs-variable constant_\",\"children\":\"WIDTH\"}],\");\\n  canvas.\",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"getContext\"}],\"(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"2d\\\"\"}],\").\",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"putImageData\"}],\"(imageData, \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0\"}],\", \",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0\"}],\");\\n};\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The worker in return defines an \",[\"$\",\"code\",null,{\"children\":\"onmessage\"}],\" method, calls the wasm function, and pass back the result using \",[\"$\",\"code\",null,{\"children\":\"postMessage\"}],\" API:\"]}],\"\\n\",[\"$\",\"pre\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"hljs language-js\",\"children\":[\"onmessage = \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"async\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"function\"}],\" (\",[\"$\",\"span\",null,{\"className\":\"hljs-params\",\"children\":\"e\"}],\") {\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" { render } = \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"await\"}],\" \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"import\"}],\"(\",[\"$\",\"span\",null,{\"className\":\"hljs-string\",\"children\":\"\\\"wasm-raytracer\\\"\"}],\");\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-keyword\",\"children\":\"const\"}],\" rendered = \",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"render\"}],\"(e.\",[\"$\",\"span\",null,{\"className\":\"hljs-property\",\"children\":\"data\"}],\"[\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"0\"}],\"], e.\",[\"$\",\"span\",null,{\"className\":\"hljs-property\",\"children\":\"data\"}],\"[\",[\"$\",\"span\",null,{\"className\":\"hljs-number\",\"children\":\"1\"}],\"]);\\n  \",[\"$\",\"span\",null,{\"className\":\"hljs-title function_\",\"children\":\"postMessage\"}],\"(rendered);\\n};\\n\"]}]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"This was all I needed to run ray tracer on a dedicated thread.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Before closing the section, I address the performance issue I tried to solve.\"}],\"\\n\",[\"$\",\"h3\",null,{\"id\":\"multi-threading\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#multi-threading\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Multi-threading\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Even though now it's separated from the main thread, running it on a single thread takes a bit of time. To improve performance, I looked at options to run it on multiple threads.\"}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"The calculation of each pixel can be done in isolatation from each other, and \",[\"$\",\"em\",null,{\"children\":\"fork-join parallelism\"}],\", which is to \",[\"$\",\"em\",null,{\"children\":\"fork\"}],\" to start a new thread and to join to \",[\"$\",\"em\",null,{\"children\":\"wait\"}],\" for it to finish, can be applied using libraries such as \",[\"$\",\"a\",null,{\"href\":\"https://github.com/rayon-rs/rayon\",\"children\":\"Rayon\"}],\".\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"Even though it wasn't difficult to turn the programme into the multi-thread version, there were a couple of challenges to run it in the browser environment:\"}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"WebAssembly threads are not supported by \",[\"$\",\"a\",null,{\"href\":\"https://webassembly.org/roadmap/\",\"children\":\"some browsers\"}],\" yet.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"To enable it, \",[\"$\",\"a\",null,{\"href\":\"https://web.dev/coop-coep/\",\"children\":\"COOP and COEP headers\"}],\" need to be configured properly, which is not possble for GitHub pages where this blog is hosted as of today.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"Because Rust's wasm build target doesn't assume it's going to be run in browsers, the standard library \",[\"$\",\"code\",null,{\"children\":\"std::thread\"}],\" is not aware of Web Workers that enable WebAssembly threads on browser environments.\"]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"The \",[\"$\",\"a\",null,{\"href\":\"https://github.com/GoogleChromeLabs/wasm-bindgen-rayon\",\"children\":[[\"$\",\"code\",null,{\"children\":\"wasm-bindgen-rayon\"}],\" library\"]}],\" enables compiling multi-thread code written with the Rayon library into threads aware wasm, but only with the nightly version of Rust.\"]}],\"\\n\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":\"For those reasons, I gave up multi-threading for now hoping I can introduce it in the near future.\"}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"why-ray-tracer\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#why-ray-tracer\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"Why ray tracer?\"]}],\"\\n\",[\"$\",\"p\",null,{\"children\":[\"This is kind of a detour from my journey of the \",[\"$\",\"a\",null,{\"href\":\"/blog/cpu-experiment\",\"children\":\"CPU experiment\"}],\" aimed at understanding what ray tracer is and how to implement it (+ not to mention learning Rust). Next challenge is to migrate the ray tracer programme to the Hack/Jack system I built while I was reading the book I introduced in the last section of the \",[\"$\",\"a\",null,{\"href\":\"/blog/the-power-of-nand\",\"children\":\"The Power of NAND\"}],\" post. Bye for now:)\"]}],\"\\n\",[\"$\",\"h2\",null,{\"id\":\"references\",\"children\":[[\"$\",\"a\",null,{\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"href\":\"#references\",\"children\":[\"$\",\"span\",null,{\"className\":\"icon icon-link\"}]}],\"References\"]}],\"\\n\",[\"$\",\"ul\",null,{\"children\":[\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://raytracing.github.io/books/RayTracingInOneWeekend.html\",\"children\":\"Ray Tracing In One Weekend\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://blog.singleton.io/posts/2022-01-02-raytracing-with-rust/\",\"children\":\"The joy of building a ray tracer, for fun, in Rust.\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://bheisler.github.io/post/writing-raytracer-in-rust-part-1/\",\"children\":\"Writing a Raytracer in Rust\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://clayto.com/2021/07/shaking-off-the-rust-2-ray-tracing-in-webassembly/\",\"children\":\"Shaking Off the Rust 2: Ray Tracing in WebAssembly\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://rustwasm.github.io/wasm-bindgen/examples/raytrace.html\",\"children\":\"Parallel Raytracing\"}]}],\"\\n\",[\"$\",\"li\",null,{\"children\":[\"$\",\"a\",null,{\"href\":\"https://web.dev/webassembly-threads/\",\"children\":\"Using WebAssembly threads from C, C++ and Rust\"}]}],\"\\n\"]}]]}]]],null],null]},[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$a\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/59ab89f451b37a95.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}],null]},[[\"$\",\"main\",null,{\"className\":\"w-full max-w-screen-md mx-auto py-4 px-4\",\"children\":[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}]}],null],null]},[[\"$\",\"html\",null,{\"lang\":\"en\",\"className\":\"__variable_03f989\",\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"script\",null,{\"async\":true,\"src\":\"https://www.googletagmanager.com/gtag/js?id=G-FC2KF4RL0P\"}],[\"$\",\"script\",null,{\"async\":true,\"dangerouslySetInnerHTML\":{\"__html\":\"\\n                window.dataLayer = window.dataLayer || [];\\n                function gtag(){dataLayer.push(arguments);}\\n                gtag('js', new Date());\\n                gtag('config', 'G-FC2KF4RL0P');\\n              \"}}]]}],[\"$\",\"body\",null,{\"children\":[[\"$\",\"$Lc\",null,{}],[\"$\",\"$L9\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$Lb\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[[\"$\",\"title\",null,{\"children\":\"404: This page could not be found.\"}],[\"$\",\"div\",null,{\"style\":{\"fontFamily\":\"system-ui,\\\"Segoe UI\\\",Roboto,Helvetica,Arial,sans-serif,\\\"Apple Color Emoji\\\",\\\"Segoe UI Emoji\\\"\",\"height\":\"100vh\",\"textAlign\":\"center\",\"display\":\"flex\",\"flexDirection\":\"column\",\"alignItems\":\"center\",\"justifyContent\":\"center\"},\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"style\",null,{\"dangerouslySetInnerHTML\":{\"__html\":\"body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}\"}}],[\"$\",\"h1\",null,{\"className\":\"next-error-h1\",\"style\":{\"display\":\"inline-block\",\"margin\":\"0 20px 0 0\",\"padding\":\"0 23px 0 0\",\"fontSize\":24,\"fontWeight\":500,\"verticalAlign\":\"top\",\"lineHeight\":\"49px\"},\"children\":\"404\"}],[\"$\",\"div\",null,{\"style\":{\"display\":\"inline-block\"},\"children\":[\"$\",\"h2\",null,{\"style\":{\"fontSize\":14,\"fontWeight\":400,\"lineHeight\":\"49px\",\"margin\":0},\"children\":\"This page could not be found.\"}]}]]}]}]],\"notFoundStyles\":[],\"styles\":null}]]}]]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[null,\"$Ld\"],\"globalErrorComponent\":\"$e\",\"missingSlots\":\"$Wf\"}]]\n"])</script><script>self.__next_f.push([1,"d:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"Ray Tracer on Web | Kenta Kudo\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"I have been working on writing a ray tracer in Rust in the last few weeks. This post is to show off what I could achieve:)\"}],[\"$\",\"meta\",\"4\",{\"property\":\"og:title\",\"content\":\"Kenta Kudo\"}],[\"$\",\"meta\",\"5\",{\"property\":\"og:description\",\"content\":\"Welcome to my page!\"}],[\"$\",\"meta\",\"6\",{\"property\":\"og:image\",\"content\":\"https://kentakudo.com/images/river-themes.jpg\"}],[\"$\",\"meta\",\"7\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"8\",{\"name\":\"twitter:creator\",\"content\":\"@___________k_k_\"}],[\"$\",\"meta\",\"9\",{\"name\":\"twitter:title\",\"content\":\"Kenta Kudo\"}],[\"$\",\"meta\",\"10\",{\"name\":\"twitter:description\",\"content\":\"Welcome to my page!\"}],[\"$\",\"meta\",\"11\",{\"name\":\"twitter:image\",\"content\":\"https://kentakudo.com/images/river-themes.jpg\"}],[\"$\",\"link\",\"12\",{\"rel\":\"icon\",\"href\":\"/favicon.ico\",\"type\":\"image/x-icon\",\"sizes\":\"72x72\"}],[\"$\",\"meta\",\"13\",{\"name\":\"next-size-adjust\"}]]\n5:null\n"])</script></body></html>